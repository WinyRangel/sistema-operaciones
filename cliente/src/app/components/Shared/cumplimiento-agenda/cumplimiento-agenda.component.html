<body>
    <div class="container-fluid p-0">
        <!-- CONTENIDO PRINCIPAL -->
        <div class="content-area">
            <div class="row mb-4">
                <div class="col-md-12">
                    <h1 class="mb-0">Seguimiento de objetivos semanales</h1>
                </div>
            </div>

            <div>
                <ul class="nav justify-content-center">
                    <li *ngFor="let coord of coordinadores" class="nav-item">
                        <button class="btn btn-outline-primary m-1" [class.active]="coord === coordinadorSeleccionado"
                            (click)="seleccionarCoordinador(coord)">
                            <i class="fas fa-user"></i>
                            <span *ngIf="isExpanded">{{ coord }}</span>
                        </button>
                    </li>
                </ul>

            </div>

            <!-- Selector de semana -->
            <div class="row align-items-end mb-3">
                <!-- Selector individual a la izquierda -->
                <div class="col-md-6">
                    <label>Selecciona una semana:</label>
                    <select name="semana" class="form-select" [(ngModel)]="semanaSeleccionada"
                        (ngModelChange)="seleccionarSemana($event)">
                        <option value="" disabled>-- Elige una semana --</option>
                        <option *ngFor="let s of semanas" [value]="s">{{ s }}</option>
                    </select>
                </div>

                <!-- Selector múltiple a la derecha -->
                <div class="col-md-6 text-end">
                    <label>Selecciona hasta 5 semanas:</label>
                    <select class="form-select" multiple [(ngModel)]="semanasSeleccionadasParaReporte">
                        <option *ngFor="let s of semanas" [value]="s">{{ s }}</option>
                    </select>
                </div>
            </div>

            <!-- Botón centrado debajo -->
            <div class="text-end mb-4">
                <button class="btn btn-success" (click)="generarReportePDF()">
                    Descargar reporte PDF
                </button>
            </div>


            <!-- CONTENEDOR IZQUIERDO: OBJETIVO -->
            <div class="container-fluid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-bullseye me-2"></i> Objetivo</h3>
                    <div class="mb-4">
                        <p class="mb-1 fw-bold fs-5">{{ objetivoSeleccionado }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="metric-value">{{ porcentajeCumplimientoObjetivo }}%</span>
                        </div>
                        <div class="metric-label">Actividades para lograr el objetivo</div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar" [ngStyle]="{
        width: porcentajeCumplimientoObjetivo + '%',
        background: colorBarraCumplimiento
      }"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small>0%</small>
                        <small>100%</small>
                    </div>

                    <div class="mt-4 table-responsive">
                        <table class="table custom-table">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Actividad</th>
                                    <th>Actividad Reportada</th>
                                    <th>Código Reportado</th>
                                    <th>Cumplimiento Agenda</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let act of actividadesObjetivo">
                                    <td>{{ act.codigo }}</td>
                                    <td>{{ act.actividad }}</td>
                                    <td>{{ act.actividadReportada }}</td>
                                    <td>{{ act.codigoReportado }}</td>
                                    <td>
                                        <i class="fas" [ngClass]="{
                'fa-check-circle text-success': act.cumplimientoAgenda,
                'fa-times-circle text-danger': !act.cumplimientoAgenda
              }"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <br>

            <!-- CONTENEDOR DERECHO: META -->
            <div class="container-fluid">
                <div class="">
                    <div class="dashboard-card">
                        <h3><i class="fas fa-flag-checkered me-2"></i>Meta</h3>
                        <div class="mb-4">
                            <p class="mb-1 fw-bold">{{ metaSeleccionada }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="metric-value">10%</span>
                                <span class="badge bg-info">En rogreso</span>
                            </div>
                            <div class="metric-label">Meta a alcanzar esta semana</div>
                        </div>

                        <div class="progress-container">
                            <div class="progress-bar" style="width: 78%; background: #5ad7eb;"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small>0%</small>
                            <small>100%</small>
                        </div>
                        <br>
                        <div class="d-flex align-items-center">
                            <!-- Grupo de controles a la izquierda -->
                            <div class="d-flex align-items-center">
                                <select class="form-select me-2" style="width: auto;">
                                    <option *ngIf="semanaSeleccionada">{{ semanaSeleccionada }}</option>
                                </select>
                                <button class="btn btn-outline-secondary me-1"
                                    (click)="mostrarFormulario('mora')">Mora</button>
                                <button class="btn btn-outline-secondary me-1"
                                    (click)="mostrarFormulario('fichas')">Fichas</button>
                                <button class="btn btn-outline-secondary me-1"
                                    (click)="mostrarFormulario('creditos')">GPO/IND Nuevos</button>
                                <button class="btn btn-outline-secondary me-1"
                                    (click)="mostrarFormulario('renovacion')">Renovaciones</button>
                                <button class="btn btn-primary me-1" (click)="guardarSeguimientoFormulario()">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>

                            <!-- Botón refresh de las tablas-->
                            <button type="button" class="btn btn-light ms-auto" (click)="recargarTablas()">
                                <i class="fas fa-refresh"></i>
                            </button>

                        </div>
                        <br>
                        <div class="formulario-container mt-4">
                            <!-- FORMULARIO PARA AGREGAR MORA -->
                            <div class="mt-4 formulario-borde" id="form-mora" *ngIf="formularioVisible === 'mora'"
                                style="border: #5ad7eb;">
                                <!-- Mora inicial y final -->
                                <div class="row mb-3 align-items-center">
                                    <div class="col-auto text-end">
                                        <label class="fw-bold">Mora inicial</label>
                                    </div>
                                    <div class="col-auto">
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" [(ngModel)]="moraInicial" class="form-control"
                                                style="width: 100px;">
                                        </div>
                                    </div>
                                    <div class="col-auto text-end">
                                        <label class="fw-bold">GPO/IND</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" [(ngModel)]="gpoindm" class="form-control"
                                            placeholder="Gpo/IND" style="width: 180px;">
                                    </div>
                                    <div class="col-auto">
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" [(ngModel)]="metaM" class="form-control"
                                                placeholder="Meta" style="width: 100px;">
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" [(ngModel)]="recupM" class="form-control"
                                                placeholder="Recup." style="width: 100px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- FORMULARIO PARA AGREGAR CLIENTES -->
                            <div class="mt-4 formulario-borde" id="form-creditos"
                                *ngIf="formularioVisible === 'creditos'">
                                <div class="row mb-3 align-items-center">
                                    <div class="col-auto text-end">
                                        <label class="fw-bold">GPO/IND iniciales</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="number" [(ngModel)]="gpoindInicial" class="form-control"
                                            style="width: 100px;">
                                    </div>
                                </div>

                                <div class="row align-items-center">
                                    <div class="col-auto text-end">
                                        <label class="fw-bold">Meta de GPO/IND</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="number" [(ngModel)]="metaGpo" class="form-control"
                                            placeholder="Meta GPO" style="width: 100px;">
                                    </div>
                                    <div class="col-auto">
                                        <input type="number" [(ngModel)]="completadoGpo" class="form-control"
                                            placeholder="Completado GPO" style="width: 100px;">
                                    </div>
                                </div>
                            </div>
                            <!-- FORMULARIO PARA AGREGAR FICHAS -->
                            <div class="mt-4 formulario-borde" id="form-fichas" *ngIf="formularioVisible === 'fichas'">
                                <div class="row mb-3 align-items-center">
                                    <div class="col-auto text-end">
                                        <label class="fw-bold">Meta de fichas por Cerrar</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="number" [(ngModel)]="fichasCerrar" class="form-control"
                                            style="width: 100px;">
                                    </div>
                                </div>
                            </div>
                            <!-- FORMULARIO PARA REALIZAR RENOVACIONES -->
                            <div class="mt-4 formulario-borde" id="form-renovacion"
                                *ngIf="formularioVisible === 'renovacion'">
                                <div class="row mb-3 align-items-center">
                                    <div class="col-auto text-end">
                                        <label class="fw-bold">GPO/IND Proyectados</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="number" [(ngModel)]="gpoindProyectado" class="form-control"
                                            style="width: 100px;">
                                    </div>
                                    <div class="col-auto text-end">
                                        <label class="fw-bold">Meta semanal</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="number" [(ngModel)]="metaProyec" class="form-control"
                                            placeholder="Meta" style="width: 100px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''' -->
                        <div class="mt-4">
                            <ng-container *ngIf="semanaSeleccionada && coordinadorSeleccionado">
                                <!-- MORA -->
                                <h5 class="text-primary" *ngIf="showMora">Mora</h5>
                                <table class="table table-bordered table-striped table-responsive" *ngIf="showMora">
                                    <thead class="table-dark text-center">
                                        <tr>
                                            <th>Mora Inicial</th>
                                            <th>GPO/IND</th>
                                            <th>Meta</th>
                                            <th>Recuperado</th>
                                            <th>Editar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let reg of cumplimientos" [hidden]="esFilaVaciaMora(reg)">
                                            <td>{{ reg.moraInicial }}</td>
                                            <td>{{ reg.gpoindm }}</td>
                                            <td>{{ reg.metaM }}</td>
                                            <td>{{ reg.recupM }}</td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-warning"
                                                    (click)="editarRegistro(reg, 'mora')">
                                                    Editar
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot *ngIf="cumplimientos.length">
                                        <tr class="table-info text-center">
                                            <td colspan="1"><strong>Total Mora Final</strong></td>
                                            <td><strong>{{totalMoraFinal}}</strong></td>
                                            <td colspan="1"><strong>Total Recuperado</strong></td>
                                            <td><strong>{{ totalRecuperado }}</strong></td>
                                            <td colspan="4"></td>
                                        </tr>
                                    </tfoot>
                                </table>

                                <!--  FICHAS -->
                                <h5 class="text-warning" *ngIf="showFichas">Fichas</h5>
                                <table class="table table-bordered table-striped table-responsive" *ngIf="showFichas">
                                    <thead class="table-dark text-center">
                                        <tr>
                                            <th>Por Cerrar</th>
                                            <th>Cerradas</th>
                                            <th>Editar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let reg of cumplimientos" [hidden]="esFilaVaciaFichas(reg)">
                                            <td>{{ reg.fichasCerrar }}</td>
                                            <td>{{ reg.fichasCerradas }}</td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-warning"
                                                    (click)="editarRegistro(reg, 'fichas')">
                                                    Editar
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot *ngIf="cumplimientos.length">
                                        <tr class="table-info text-center">
                                            <td><strong>Total de Faltantes = {{ totalFichasFaltantes }}</strong></td>
                                            <td><strong>Fichas Cerradas = {{totalFichasCerradas}}</strong></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>

                                <!--  CRÉDITOS -->
                                <h5 class="text-success" *ngIf="showCreditos">Créditos (GPO/IND)</h5>
                                <table class="table table-bordered table-striped table-responsive" *ngIf="showCreditos">
                                    <thead class="table-dark text-center">
                                        <tr>
                                            <th>Iniciales</th>
                                            <th>Meta GPO/IND</th>
                                            <th>Completado GPO/IND</th>
                                            <th>Editar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let reg of cumplimientos" [hidden]="esFilaVaciaCredito(reg)">
                                            <td>{{ reg.gpoindInicial }}</td>
                                            <td>{{ reg.metaGpo }}</td>
                                            <td>{{ reg.completadoGpo }}</td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-warning"
                                                    (click)="editarRegistro(reg, 'creditos')">
                                                    Editar
                                                </button>

                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot *ngIf="cumplimientos.length">
                                        <tr class="table-info text-center">
                                            <td><strong>Total de GPO/IND =
                                                {{ totalCreditosFinales }}</strong></td>
                                            <td></td>
                                            <!-- <td><strong>{{ totalCreditosFinales }}</strong></td> -->
                                            <td colspan=""><strong>Total de GPO/IND Nuevos = {{totalCreditosCreados}}</strong></td>
                                            <!-- <td><strong>{{totalCreditosCreados}}</strong></td> -->
                                             <td></td>
                                        </tr>
                                    </tfoot>
                                </table>

                                <!--  RENOVACIONES -->
                                <h5 class="text-danger" *ngIf="showRenovaciones">Renovaciones</h5>
                                <table class="table table-bordered table-striped table-responsive"
                                    *ngIf="showRenovaciones">
                                    <thead class="table-dark text-center">
                                        <tr>
                                            <th>Proyectados</th>
                                            <th>Meta</th>
                                            <th>Completado</th>
                                            <th>Editar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let reg of cumplimientos" [hidden]="esFilaVaciaRenovaciones(reg)">
                                            <td>{{ reg.gpoindProyectado }}</td>
                                            <td>{{ reg.metaProyec }}</td>
                                            <td>{{ reg.completadosProyec }}</td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-warning"
                                                    (click)="editarRegistro(reg, 'renovacion')">
                                                    Editar
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot *ngIf="cumplimientos.length">
                                        <tr class="table-info text-center">
                                            <td><strong>Total de faltantes = {{ totalProyecFaltantes }}</strong></td>
                                            <td></td>
                                            <td><strong>Total de renovados = {{ totalRenovados }}</strong></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </ng-container>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Bootstrap -->
            <div class="modal fade" tabindex="-1" [class.show]="modalVisible"
                [style.display]="modalVisible ? 'block' : 'none'">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Editar Registro</h5>
                            <button type="button" class="btn-close" (click)="cerrarModal()"></button>
                        </div>
                        <div class="modal-body" *ngIf="modalData">
                            <!-- Campos comunes -->
                            <div class="mb-3">
                                <label class="form-label">Coordinador</label>
                                <input class="form-control" [(ngModel)]="modalData.coordinador" disabled />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Semana</label>
                                <input class="form-control" [(ngModel)]="modalData.semana" disabled />
                            </div>

                            <!-- MORA -->
                            <ng-container *ngIf="modalData.tipo === 'mora'">
                                <div class="row g-2">
                                    <div class="col">
                                        <label>Mora Inicial</label>
                                        <input type="number" class="form-control" [(ngModel)]="modalData.moraInicial">
                                    </div>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col">
                                        <label>GPO/IND</label>
                                        <input type="text" class="form-control" [(ngModel)]="modalData.gpoindm">
                                    </div>
                                    <div class="col">
                                        <label>Meta</label>
                                        <input type="number" class="form-control" [(ngModel)]="modalData.metaM">
                                    </div>
                                    <div class="col">
                                        <label>Recup.</label>
                                        <input type="number" class="form-control" [(ngModel)]="modalData.recupM">
                                    </div>
                                </div>
                            </ng-container>

                            <!-- FICHAS -->
                            <ng-container *ngIf="modalData.tipo === 'fichas'">
                                <div class="row g-2">
                                    <div class="col">
                                        <label>Fichas Cerradas</label>
                                        <input type="number" class="form-control"
                                            [(ngModel)]="modalData.fichasCerradas">
                                    </div>
                                </div>
                            </ng-container>

                            <!-- CREDITOS -->
                            <ng-container *ngIf="modalData.tipo === 'creditos'">
                                <div class="row g-2">
                                    <div class="col">
                                        <label>Iniciales</label>
                                        <input type="number" class="form-control" [(ngModel)]="modalData.gpoindInicial">
                                    </div>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col">
                                        <label>Completado GPO/IND</label>
                                        <input type="number" class="form-control" [(ngModel)]="modalData.completadoGpo">
                                    </div>
                                </div>
                            </ng-container>

                            <!-- RENOVACIONES -->
                            <ng-container *ngIf="modalData.tipo === 'renovacion'">
                                <div class="row g-2 mt-2">
                                    <div class="col">
                                        <label>Creditos Renovados</label>
                                        <input type="number" class="form-control"
                                            [(ngModel)]="modalData.completadosProyec">
                                    </div>
                                </div>
                            </ng-container>

                            <!-- Fallback -->
                            <ng-container *ngIf="!['mora','fichas','creditos','renovacion'].includes(modalData.tipo!)">
                                <p class="text-danger">Tipo de formulario desconocido: {{ modalData.tipo }}</p>
                            </ng-container>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
                            <button class="btn btn-primary" (click)="guardarDesdeModal()">Guardar cambios</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen adicional -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-bar me-2"></i> Progreso</h3>
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <div class="metric-value text-success">78%</div>
                                <div class="metric-label">Cumplimiento</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="metric-value text-primary">24</div>
                                <div class="metric-label">Actividades</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="metric-value text-warning">18</div>
                                <div class="metric-label">En progreso</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="metric-value text-danger">2</div>
                                <div class="metric-label">Retrasadas</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>